# Orquestador para todo el monorepo (FRONT + BACK)
# Uso: desde la raíz RRHH -> docker compose up -d --build

services:
  # PHP-FPM (Laravel)
  app:
    build:
      context: ./BACK
      dockerfile: Dockerfile
    image: rrhh_back_app:latest
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./BACK:/var/www/html:delegated
      - back_vendor:/var/www/html/vendor
      - back_node_modules:/var/www/html/node_modules
    environment:
      - APP_ENV=local
      - APP_DEBUG=true
      - DB_CONNECTION=mysql
      - DB_HOST=back_db
      - DB_PORT=3306
      - DB_DATABASE=laravel
      - DB_USERNAME=laravel
      - DB_PASSWORD=secret
    healthcheck:
      test: ["CMD-SHELL", "php -r 'exit(@fsockopen(\"127.0.0.1\",9000) ? 0 : 1);'"]
      interval: 10s
      timeout: 2s
      retries: 3
      start_period: 5s
    depends_on:
      - back_db

  # Nginx (servirá la API en http://localhost:8000)
  back_nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    ports:
      - "8000:80"
    volumes:
      - ./BACK:/var/www/html:delegated
      - ./BACK/docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - app

  # Base de datos (MySQL)
  back_db:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_PORT: 3306
      MYSQL_DATABASE: laravel
      MYSQL_USER: laravel
      MYSQL_PASSWORD: secret
    ports:
      - "3306:3306"
    # DB mapea puerto al host para accesos locales (dev)
    volumes:
      - back_dbdata:/var/lib/mysql

  # Reverb WebSocket server – correrlo en la misma imagen que el backend
  back_reverb:
    build:
      context: ./BACK
      dockerfile: Dockerfile
    image: rrhh_back_reverb:latest
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./BACK:/var/www/html:delegated
      - back_vendor:/var/www/html/vendor
    env_file:
      - ./BACK/.env
    environment:
      - REVERB_SERVER_HOST=0.0.0.0
      - REVERB_SERVER_PORT=6001
      - DB_HOST=back_db
      - DB_PORT=3306
      - DB_DATABASE=laravel
      - DB_USERNAME=laravel
      - DB_PASSWORD=secret
    ports:
      - "6001:6001"
    command: php artisan reverb:start --host=0.0.0.0 --port=6001
    depends_on:
      - back_db
      - app

  # Frontend (Nuxt dev server) — puede consumir la API vía http://back_nginx
  front:
    build:
      context: ./FRONT
      dockerfile: Dockerfile
    image: rrhh_front:latest
    restart: unless-stopped
    working_dir: /app
    user: root
    env_file:
      - ./BACK/.env
    environment:
      - NODE_ENV=development
      - HOST=0.0.0.0
      - PORT=3000
      # runtime public config for Nuxt 3 (usa NUXT_PUBLIC_*)
      - NUXT_PUBLIC_API_BASE=http://localhost:8000
      # Reverb websocket settings (pusher-compatible)
      # browser should connect to localhost (mapped above)
      - NUXT_PUBLIC_REVERB_HOST=localhost
      - NUXT_PUBLIC_REVERB_PORT=6001
    ports:
      - "3000:3000"
    command: sh -c "npm install --no-audit --no-fund && npx nuxi dev /app --hostname 0.0.0.0 --port 3000"
    volumes:
      - ./FRONT:/app:delegated
      - front_node_modules:/app/node_modules
    depends_on:
      - back_nginx

volumes:
  back_vendor:
  back_node_modules:
  back_dbdata:
  front_node_modules:
